{"componentChunkName":"component---src-templates-blog-post-js","path":"/2017-10-30-oauth-on-docker-part2/","result":{"data":{"site":{"siteMetadata":{"title":"The Plastic Neuron"}},"markdownRemark":{"id":"50ec8124-c2d7-55f7-ba6e-50b2a0577012","excerpt":"In Part 1 we built an ASP.NET Core 2 API and got an Identity Server all running on docker containers. In this part we’re going to add a client application that…","html":"<p>In <a href=\"/2017-10-30-oauth-on-docker-part1\">Part 1</a> we built an ASP.NET Core 2 API and got an Identity Server all running on docker containers. In this part we’re going to add a client application that can get a token from the Identity Server, apply authorization to the API service and then use the token to call the service.</p>\n<p>You can grab the completed code from the <a href=\"https://github.com/brainwipe/DockerDotNetOAuth\">DockerDotNetOAuth</a> GitHub repository.</p>\n<h2>Specify Port Binding in Docker Compose</h2>\n<p>Up until now we’ve let docker compose decide what ports we’re going to use. This has been fine so far but we need to fix them so that the client HTML page knows where its resources are. The best solution is to use domains and forwarding but that’s out of the scope of this post.</p>\n<p>Open <code class=\"language-text\">docker-compose.yml</code> and update the existing services to include the port numbers:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token key atrule\">dockerdotnetoauth</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> dockerdotnetoauth\r\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\r\n      <span class=\"token punctuation\">-</span> 32771<span class=\"token punctuation\">:</span><span class=\"token number\">80</span>\r\n    <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span>\r\n      <span class=\"token key atrule\">context</span><span class=\"token punctuation\">:</span> ./DockerDotNetOAuth\r\n      <span class=\"token key atrule\">dockerfile</span><span class=\"token punctuation\">:</span> Dockerfile\r\n\r\n  <span class=\"token key atrule\">identityserver</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> identityserver\r\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\r\n      <span class=\"token punctuation\">-</span> 32772<span class=\"token punctuation\">:</span><span class=\"token number\">80</span>\r\n    <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span>\r\n      <span class=\"token key atrule\">context</span><span class=\"token punctuation\">:</span> ./IdentityServer\r\n      <span class=\"token key atrule\">dockerfile</span><span class=\"token punctuation\">:</span> Dockerfile</code></pre></div>\n<p>This is the same port binding that we saw in the <code class=\"language-text\">docker ps</code> command. Now with subsequent runs of the system, the ports will remain the same.</p>\n<h2>Client Docker Container</h2>\n<p>For our client, we’re going to use an HTML web page running on an nginx docker container. We’ll get the client container running first and then come back for the HTML.</p>\n<p>In your solution folder, create a new folder called Client. You’ll need to do the same in Visual Studio. In the Client folder, add a new file called <code class=\"language-text\">Dockerfile</code> (no extension). The DockerFile is going to describe how to build our client container image. The DockerFile is extremely simple:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\">FROM nginx\r\nEXPOSE 32773</code></pre></div>\n<p>For our system to turn this DockerFile description into a container image, we need to add it to our <code class=\"language-text\">docker-compose.yml</code> file. Add the following section into your docker-compose file under your other services. Make sure that the <code class=\"language-text\">testclient</code> is aligned with the pre-existing <code class=\"language-text\">identityserver:</code> line.</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">testclient</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> testclient\r\n    <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span> \r\n      <span class=\"token key atrule\">context</span><span class=\"token punctuation\">:</span> ./Client\r\n      <span class=\"token key atrule\">dockerfile</span><span class=\"token punctuation\">:</span> Dockerfile\r\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\r\n      <span class=\"token punctuation\">-</span> ./Client<span class=\"token punctuation\">:</span>/usr/share/nginx/html\r\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\r\n     <span class=\"token punctuation\">-</span> 32773<span class=\"token punctuation\">:</span><span class=\"token number\">80</span></code></pre></div>\n<p>This will use the DockerFile found in the <code class=\"language-text\">./Client</code> folder and bind external port <code class=\"language-text\">32773</code> to the nginx default of port <code class=\"language-text\">80</code>. You can run the solution at this point and the container will run but there won’t be any content at <code class=\"language-text\">http://localhost:32773/</code> because we’ve not make the HTML yet, nginx will give a 403 by default.</p>\n<h3>Volumes</h3>\n<p>Different to our other containers is <code class=\"language-text\">volumes</code>, this line maps a folder on our hard-drive with a folder in the running container. We want to do this so that when we update the client HTML file (we’re about to build) then the container updates automatically. This saves us from having to rebuild the container image every time we make an HTML change. This is useful for the client as it’s only a single HTML page that doesn’t have a build process.</p>\n<p>If you are using .NET or webpack or npm or any modern front end tooling you will have a build chain whose output can be put into the container image on each build. The benefit of copying the build output into the container image is that then the resulting container contains <em>everything you need to run the site</em>. You can deploy that image to test, staging and so on. If you use volumes then you are depending on files outside the container.</p>\n<h2>Create simple HTML client</h2>\n<p>We’re going to use jQuery to get a token from Identity Server. Add a new HTML file called <code class=\"language-text\">index.html</code> in <code class=\"language-text\">./Client/</code>. Here’s the source:</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token doctype\"><span class=\"token punctuation\">&lt;!</span><span class=\"token doctype-tag\">DOCTYPE</span> <span class=\"token name\">html</span><span class=\"token punctuation\">></span></span>\r\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>html</span><span class=\"token punctuation\">></span></span>\r\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>head</span><span class=\"token punctuation\">></span></span>\r\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>title</span><span class=\"token punctuation\">></span></span>Test Client<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>title</span><span class=\"token punctuation\">></span></span>\r\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>head</span><span class=\"token punctuation\">></span></span>\r\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>body</span><span class=\"token punctuation\">></span></span>\r\nTest Client\r\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>https://code.jquery.com/jquery-3.2.1.min.js<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span><span class=\"token script\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span>\r\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span><span class=\"token punctuation\">></span></span><span class=\"token script\"><span class=\"token language-javascript\">\r\n    <span class=\"token keyword\">function</span> <span class=\"token function\">GetToken</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        $<span class=\"token punctuation\">.</span><span class=\"token function\">ajax</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\r\n                <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">'POST'</span><span class=\"token punctuation\">,</span>\r\n                <span class=\"token literal-property property\">url</span><span class=\"token operator\">:</span> <span class=\"token string\">'http://localhost:32772/connect/token'</span><span class=\"token punctuation\">,</span>\r\n                <span class=\"token literal-property property\">crossDomain</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\r\n                <span class=\"token literal-property property\">timeout</span><span class=\"token operator\">:</span> <span class=\"token number\">2000</span><span class=\"token punctuation\">,</span>\r\n                <span class=\"token literal-property property\">data</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\r\n                    <span class=\"token string-property property\">\"client_id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"client\"</span><span class=\"token punctuation\">,</span>\r\n                    <span class=\"token string-property property\">\"grant_type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"client_credentials\"</span><span class=\"token punctuation\">,</span>\r\n                    <span class=\"token string-property property\">\"client_secret\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"secret\"</span><span class=\"token punctuation\">,</span>\r\n                    <span class=\"token string-property property\">\"scopes\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"api1\"</span>\r\n                <span class=\"token punctuation\">}</span>\r\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n            <span class=\"token punctuation\">.</span><span class=\"token function\">done</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n                console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Got token: \"</span> <span class=\"token operator\">+</span> data<span class=\"token punctuation\">.</span>access_token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n\r\n    <span class=\"token function\">$</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token function\">GetToken</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n</span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span>\r\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>body</span><span class=\"token punctuation\">></span></span>\r\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>html</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>Once the page has loaded then a POST Ajax query is sent to the token creation endpoint of Identity Server with the scope <code class=\"language-text\">api1</code>, secret of <code class=\"language-text\">secret</code>, client name of <code class=\"language-text\">id</code> and a grant type of <code class=\"language-text\">client_credentials</code>, which simply means that a secret is all that’s required. If it is successful then it will print the token to the javascript console.</p>\n<p>In Visual Studio Press <kbd>F5</kbd> to see it fail!</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/24671e2b30e554593b2173c20f1e09f6/65654/aspnet-core2-cors.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 13.924050632911392%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAB2HAAAdhwGP5fFlAAAAmUlEQVQI11XLS07EMBAA0dz/kKBRMhknxHbbbbcDCl0jPkJi8ValmlIp1NboZlRVVJXe+5+iimhFvprZj97/+/1LKUzXsuJhw0JA5pn9diOtK8eyEO93PkLAXl55nxf8EfD1ge87HiN+HPjbASKcOVO3jYkseBYuKd9MBE2JGiMtZ1wVpECteMqQM7QGY4AN3AacJ59jcI3BE+Sw5exVbRc0AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"We haven&#39;t set up CORS yet\"\n        title=\"We haven&#39;t set up CORS yet\"\n        src=\"/static/24671e2b30e554593b2173c20f1e09f6/f058b/aspnet-core2-cors.png\"\n        srcset=\"/static/24671e2b30e554593b2173c20f1e09f6/c26ae/aspnet-core2-cors.png 158w,\n/static/24671e2b30e554593b2173c20f1e09f6/6bdcf/aspnet-core2-cors.png 315w,\n/static/24671e2b30e554593b2173c20f1e09f6/f058b/aspnet-core2-cors.png 630w,\n/static/24671e2b30e554593b2173c20f1e09f6/65654/aspnet-core2-cors.png 872w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h2>Setting up CORS on Identity Server</h2>\n<p>The error above is telling us that the server will not accept POST requests from our origin:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Failed to load http://localhost:32772/connect/token: No 'Access-Control-Allow-Origin' header is present on the requested resource. \r\nOrigin 'http://localhost:32773' is therefore not allowed access. The response had HTTP status code 400.</code></pre></div>\n<p>As the Identity Server and client are hosted on different ports, they are different origins, so this is a Cross Origin request and the Identity Server needs to have <a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS\">Cross Origin Resource Sharing</a> enabled.</p>\n<p>First we’re going to “turn off” ASP.NET’s CORS system as Identity Server can do it with much more granularity. Open <code class=\"language-text\">startup.cs</code> and add the following line into the <code class=\"language-text\">Configure(...)</code> method.</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\">app<span class=\"token punctuation\">.</span><span class=\"token function\">UseCors</span><span class=\"token punctuation\">(</span>builder <span class=\"token operator\">=></span>builder<span class=\"token punctuation\">.</span><span class=\"token function\">AllowAnyOrigin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">AllowAnyHeader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">AllowAnyMethod</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">AllowCredentials</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Next we’re going to tell Identity Server to use an in memory CORS policy. Update your <code class=\"language-text\">ConfigureServices(...)</code> method to:</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\">services<span class=\"token punctuation\">.</span><span class=\"token function\">AddIdentityServer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">.</span><span class=\"token function\">AddInMemoryApiResources</span><span class=\"token punctuation\">(</span>Configuration<span class=\"token punctuation\">.</span><span class=\"token function\">GetApiResources</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">.</span><span class=\"token function\">AddInMemoryClients</span><span class=\"token punctuation\">(</span>Configuration<span class=\"token punctuation\">.</span><span class=\"token function\">GetClients</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">AddCorsPolicyService</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>InMemoryCorsPolicyService<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// Add the CORS service</span>\r\n    <span class=\"token punctuation\">.</span><span class=\"token function\">AddDeveloperSigningCredential</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Finally we need to tell Identity Server which origins are allowed. Open <code class=\"language-text\">Configuration.cs</code> and add the following under <code class=\"language-text\">AllowedScopes</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\">AllowedCorsOrigins <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"http://localhost:32773\"</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>This allows only the test client to request tokens. Run the app <kbd>F5</kbd>, point your browser at your <a href=\"http://localhost:32771\">test client</a>, open the console and you should see the token that we’re going to pass to the API. It will look something like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Got token: eyJhbGciOiJSUzI1NiIsImtpZCI6IjUzZTVjZDE3YWEzYjkxZGUwMmUyZWI5MzdiODdmZTU2IiwidHlwIjoiSldUIn0.eyJuYmYiOjE1MDkzNzQ1MzAsImV4cCI6MTUwOTM3ODEzMCwiaXNzIjoiaHR0cDovL2xvY2FsaG9zdDozMjc3MiIsImF1ZCI6WyJodHRwOi8vbG9jYWxob3N0OjMyNzcyL3Jlc291cmNlcyIsImFwaTEiXSwiY2xpZW50X2lkIjoiY2xpZW50Iiwic2NvcGUiOlsiYXBpMSJdfQ.DkS9Wcb3AzvzcCJS1JnBICE9pBuzc4d8j1LzbUcgyjKbha56c3NSNyT6W0yZSm5LA5aaBbMVJMnZYYrfbCGDUkbKbX2NmKfkrB16O0y5BH2z1ruBXjMUG2Iks36VYbsGS8ZBd7InTmPeYk4hdjygDkLyFlH5WI94_KKYIE5wPQNVH2d7iiQgocKI8WlIphCCLjPA5CG-kyTYl8zUtT9lxh1fJcXtjvZKphfpbPijgw5_l0fZWvnlk4GS0Xi9bvsFxwATV3ISw_geUCKSWV5sojFCnIyeCgtlmGXFUvetUvVB1xVpuRN-JU1LVGgT1Fx3kszLdwip_wahu-CnooOcpA</code></pre></div>\n<h2>Setting CORS on the API</h2>\n<p>Before we add authorization onto the API, we must tell the API that the client site is allowed to access it. We do this with CORS but unlike we did in <a href=\"/2017-10-30-oauth-on-docker-part1\">Part 1</a>, we want ASP.NET to control access rather than Identity Server.</p>\n<p>Open <code class=\"language-text\">startup.cs</code>, in <code class=\"language-text\">ConfigureServices(...)</code> add:</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\">services<span class=\"token punctuation\">.</span><span class=\"token function\">AddCors</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>In <code class=\"language-text\">Configure(...)</code> add <em>before</em> <code class=\"language-text\">UseMvc()</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\">app<span class=\"token punctuation\">.</span><span class=\"token function\">UseCors</span><span class=\"token punctuation\">(</span>\r\n    builder <span class=\"token operator\">=></span> builder\r\n        <span class=\"token punctuation\">.</span><span class=\"token function\">AllowAnyHeader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n        <span class=\"token punctuation\">.</span><span class=\"token function\">AllowAnyMethod</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n        <span class=\"token punctuation\">.</span><span class=\"token function\">WithOrigins</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"http://localhost:32773\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>This is saying that it will allow any header value, any method (POST, GET, PUT etc) from the client website. Before production we would limit this to just the methods and headers we want.</p>\n<h2>Setting Issuer Uri on Identity Server</h2>\n<p>When we run Identity Server as a developer on our local boxes, we map the port such that we can simply go to <code class=\"language-text\">http://localhost:32772/</code>. The API needs to be able to contact the Identity Server to get the discovery document and check the client’s token then it needs a URI to call. The default Issuer Uri for the Identity Server is also <code class=\"language-text\">http://localhost:32772</code>. You can double check this on the discovery document at <a href=\"localhost:32772/.well-known/openid-configuration\">localhost:32772/.well-known/openid-configuration</a>.</p>\n<p>Our system is built within docker containers, so when the API calls <code class=\"language-text\">localhost:32772</code> then it will look at port <code class=\"language-text\">32772</code> of its own container. So the API will need to use <code class=\"language-text\">http://identityserver</code> instead (we’ll set that in the next step). However this will not work straight away because the Issuer Uri in Identity Server and the Authority used by the API need to match. Therefore we need to override the Issuer Uri in Identity Server to <code class=\"language-text\">http://identityserver</code>.</p>\n<p>Open the Identity Server <code class=\"language-text\">Startup.cs</code> and in <code class=\"language-text\">ConfigureServices(...)</code> change the <code class=\"language-text\">AddIdentityServer()</code> line to:</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\">services<span class=\"token punctuation\">.</span><span class=\"token function\">AddIdentityServer</span><span class=\"token punctuation\">(</span>opt <span class=\"token operator\">=></span> opt<span class=\"token punctuation\">.</span>IssuerUri <span class=\"token operator\">=</span> <span class=\"token string\">\"http://identityserver\"</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>When you now call the discovery document on <a href=\"localhost:32772/.well-known/openid-configuration\">localhost:32772/.well-known/openid-configuration</a> then you’ll see the Issuer Uri is <code class=\"language-text\">\"http://identityserver\"</code>.</p>\n<h3>This is simple but not ideal</h3>\n<p>This works for our example but the best solution (not covered here) is to assign domains to your containers. If we had an API external to your docker host then it would not be able to validate tokens against <code class=\"language-text\">http://identityserver</code> because that URI is only understood inside your docker host.</p>\n<h2>Securing the API Service</h2>\n<p>In this step we’re going to secure our <code class=\"language-text\">api/value</code> web service so that it requires a bearer token. First we’re going to install the <a href=\"https://www.nuget.org/packages/IdentityServer4.AccessTokenValidation/\">IdentityServer4.AccesstokenValidation</a> nuget package into our API project.</p>\n<p>Open <code class=\"language-text\">Startup.cs</code>, in <code class=\"language-text\">ConfigureService(...)</code> add:</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\">services<span class=\"token punctuation\">.</span><span class=\"token function\">AddAuthentication</span><span class=\"token punctuation\">(</span>opt <span class=\"token operator\">=></span>\r\n    <span class=\"token punctuation\">{</span>\r\n        opt<span class=\"token punctuation\">.</span>DefaultScheme <span class=\"token operator\">=</span> IdentityServerAuthenticationDefaults<span class=\"token punctuation\">.</span>AuthenticationScheme<span class=\"token punctuation\">;</span>\r\n        opt<span class=\"token punctuation\">.</span>DefaultAuthenticateScheme <span class=\"token operator\">=</span> IdentityServerAuthenticationDefaults<span class=\"token punctuation\">.</span>AuthenticationScheme<span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">.</span><span class=\"token function\">AddIdentityServerAuthentication</span><span class=\"token punctuation\">(</span>\r\n        opt <span class=\"token operator\">=></span>\r\n        <span class=\"token punctuation\">{</span>\r\n            opt<span class=\"token punctuation\">.</span>Authority <span class=\"token operator\">=</span> <span class=\"token string\">\"http://identityserver\"</span><span class=\"token punctuation\">;</span>\r\n            opt<span class=\"token punctuation\">.</span>RequireHttpsMetadata <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\r\n            opt<span class=\"token punctuation\">.</span>ApiName <span class=\"token operator\">=</span> <span class=\"token string\">\"api1\"</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>The first call to services (<code class=\"language-text\">AddAuthentication</code>) sets the authentication scheme to <code class=\"language-text\">bearer</code> and then the identity server is given as the secure token server. We don’t need the secret at this point because we’re not a client. We will take the token from the client and pass it to the Identity Server to check.</p>\n<p>In the <code class=\"language-text\">Configure(...)</code> method, add authentication to pipeline <em>before</em> <code class=\"language-text\">UseMvc()</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\">app<span class=\"token punctuation\">.</span><span class=\"token function\">UseAuthentication</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Finally we need to specify which controllers need authentication. Open <code class=\"language-text\">./Controllers/ValuesController.cs</code> and add the <code class=\"language-text\">Authorize</code> attribute to the controller like so:</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\">    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">Route</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"api/[controller]\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\r\n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">Authorize</span></span><span class=\"token punctuation\">]</span>\r\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ValuesController</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">Controller</span></span>\r\n    <span class=\"token punctuation\">{</span>\r\n        <span class=\"token comment\">// Snip for brevity</span></code></pre></div>\n<h2>Test without the token</h2>\n<p>Before we start using the token, press <kbd>F5</kbd> and the sites will run up. If you go to <code class=\"language-text\">http://localhost:32771/api/values</code> then nothing will appear, in the browser’s console (press F12), the network tab will show <code class=\"language-text\">401 Unauthorized</code>. Identity Server isn’t being called at all, though because there is no token supplied so ASP.NET responds automatically.</p>\n<h2>Calling the Values Service with a token</h2>\n<p>We’re now going to call the <code class=\"language-text\">api/values</code> service from our test client using the token we already have.</p>\n<p>Open <code class=\"language-text\">./Client/index.html</code> and add this function inside the <code class=\"language-text\">&lt;script></code> tag:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">CallService</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">token</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    $<span class=\"token punctuation\">.</span><span class=\"token function\">ajax</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\r\n            <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">'GET'</span><span class=\"token punctuation\">,</span>\r\n            <span class=\"token literal-property property\">url</span><span class=\"token operator\">:</span> <span class=\"token string\">'http://localhost:32771/api/values'</span><span class=\"token punctuation\">,</span>\r\n            <span class=\"token literal-property property\">crossDomain</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\r\n            <span class=\"token literal-property property\">timeout</span><span class=\"token operator\">:</span> <span class=\"token number\">2000</span><span class=\"token punctuation\">,</span>\r\n            <span class=\"token function-variable function\">beforeSend</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">xhr</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> xhr<span class=\"token punctuation\">.</span><span class=\"token function\">setRequestHeader</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Authorization'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'Bearer '</span> <span class=\"token operator\">+</span> token<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\r\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n        <span class=\"token punctuation\">.</span><span class=\"token function\">done</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n            console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This function calls the values API, adding in a Bearer token as the authorization header. For simplicity we’re going to call this from the <code class=\"language-text\">done</code> promise of the <code class=\"language-text\">GetToken()</code> call we had before:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">    <span class=\"token punctuation\">.</span><span class=\"token function\">done</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Got token: \"</span> <span class=\"token operator\">+</span> data<span class=\"token punctuation\">.</span>access_token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token function\">CallService</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>access_token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>When you reload the test client page <a href=\"http://localhost:32773/\">http://localhost:32773/</a> then the client first authenticates against Identity Server to get a token and that token is used in the <code class=\"language-text\">Authorization</code> header to call the values API. We have a success! I looks like:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d12170c7cb80a3b028c5b7a4bac54197/31198/aspnet-core2-result.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 32.278481012658226%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAB2HAAAdhwGP5fFlAAAA8ElEQVQY05VQ24qDMBD1//9sYV8Ki4tRc1OEba1NNBqDxVNmlvRh33bgcGbOZG4p7tcfOOcRQsC2bVjXFd57zPPMPukE0px7sE7v/iIdBy6fHyj8dMf1duOilBInl2XhZvu+I8bITI28d5yjOINqpmnCElaIrwuK4B9QSkG2LbTW6LoOfd/DGMM6+aRRLvtSSmZrLXMtBJTWUOIbhZtGCCHQNA2DfKnkO67rmrWyLJmrqmIt6xSP4wgy24rfk2kbS1ONQa81tJQ8fRiG9xZ5a2IC5QjOOT75BNBRw7gGHMeBMyWcmZ9P/Mfov+OeYJsKL8gcwszfHha4AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Chrome console has both the token and the values from the API\"\n        title=\"Chrome console has both the token and the values from the API\"\n        src=\"/static/d12170c7cb80a3b028c5b7a4bac54197/f058b/aspnet-core2-result.png\"\n        srcset=\"/static/d12170c7cb80a3b028c5b7a4bac54197/c26ae/aspnet-core2-result.png 158w,\n/static/d12170c7cb80a3b028c5b7a4bac54197/6bdcf/aspnet-core2-result.png 315w,\n/static/d12170c7cb80a3b028c5b7a4bac54197/f058b/aspnet-core2-result.png 630w,\n/static/d12170c7cb80a3b028c5b7a4bac54197/31198/aspnet-core2-result.png 694w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>We have the token printed first and then the result from the API call.</p>\n<h2>Well done for making it this far</h2>\n<p>If you jumped in at this point, check out <a href=\"/2017-10-30-oauth-on-docker-part1\">Part 1</a> and you can grab the code from the <a href=\"https://github.com/brainwipe/DockerDotNetOAuth\">DockerDotNetOAuth</a> GitHub repository.</p>","frontmatter":{"title":"ASP.NET Core 2 API on Docker with OAuth (Part 2)","date":"October 30, 2017","description":null}},"previous":{"fields":{"slug":"/2017-10-30-oauth-on-docker-part1/"},"frontmatter":{"title":"ASP.NET Core 2 API on Docker with OAuth (Part 1)"}},"next":{"fields":{"slug":"/2018-07-11-aws-ecr-docker-powershell/"},"frontmatter":{"title":"AWS Elastic Container Registry with docker compose on Powershell"}}},"pageContext":{"id":"50ec8124-c2d7-55f7-ba6e-50b2a0577012","previousPostId":"11f3b983-6069-5ae5-8298-6f69aaa7cde8","nextPostId":"86b76ebd-005e-5408-aa9e-727a1ab8f7c1"}},"staticQueryHashes":["2841359383","69202846"]}