{"componentChunkName":"component---src-templates-blog-post-js","path":"/2022-10-31-aws-msk-dotnet/","result":{"data":{"site":{"siteMetadata":{"title":"The Plastic Neuron"}},"markdownRemark":{"id":"610e9902-24ec-5f65-9a84-6a269384c174","excerpt":"This guide looks at connecting a .NET Core client to an AWS Kafka (MSK) cluster using Mutual TLS. We’re going to focus on the mutual TLS authentication, how to…","html":"<p>This guide looks at connecting a .NET Core client to an AWS Kafka (MSK) cluster using Mutual TLS. We’re going to focus on the mutual TLS authentication, how to make certificates, a CA and certificate requests.</p>\n<blockquote>\n<p>WARNING: You will be charged by AWS.</p>\n</blockquote>\n<p>Much of the instructions below will include a charge by AWS. That’s my only warning.</p>\n<h2>Pre-requisites</h2>\n<ul>\n<li><code class=\"language-text\">openssl</code> <a href=\"https://wiki.openssl.org/index.php/Binaries\">Windows binaries here</a></li>\n<li><a href=\"https://aws.amazon.com/cli/\">AWS CLI access</a></li>\n</ul>\n<h2>AWS API and Kafka Connections</h2>\n<p>The first aspect to wrap your head around is that there are two API. AWS MSK and Confluent Kafka.</p>\n<p>AWS MSK is for managing the cluster itself and needs IAM permissions. You use the <a href=\"https://www.nuget.org/packages/AWSSDK.Kafka/\">AWSSDK.Kafka nuget package</a> for that. That package will <strong>not</strong> let you connect to the Kafka brokers themselves. Only for cluster admin.</p>\n<p>Confluent Kafka is for producing/consuming messages to/from the Kafka queue itself. You use the <a href=\"https://www.nuget.org/packages/Confluent.Kafka/\">Confluent.Kafka nuget package</a> for that.</p>\n<p>If you’re not going to be administering the AWS MSK cluster through code then you don’t need the AWSSDK!</p>\n<h2>Not covering generic Kafka use</h2>\n<p>There are lots of guides on how to use Confluent.Kafka to connect to a Kafka cluster from .NET. I liked <a href=\"https://awswith.net/2020/11/01/developing-net-core-applications-for-apache-kafka-and-amazon-msk/\">Developing .NET Core Applications for Apache Kafka and Amazon MSK</a> although it is very light on the detail on the MSK part.</p>\n<p><a href=\"https://docs.confluent.io/kafka-clients/dotnet/current/overview.html\">The official documentation</a> is also good but leans heavily on Confluent’s own cloud.</p>\n<h2>Create an AWS Private Certificate Authority</h2>\n<p>A <a href=\"https://www.digicert.com/blog/what-is-a-certificate-authority\">certificate authority</a> (CA) is usually a company or organisation that validates websites, emails and so on. A <em>private</em> certificate authority is where <em>you</em> are the organisation doing the validating (through AWS) for your own services inside AWS.</p>\n<p>You can use certificates issued by <a href=\"https://www.verisign.com/en_US/website-presence/online/ssl-certificates/index.xhtml\">Verisign</a> or <a href=\"https://letsencrypt.org/\">LetsEncrypt</a> or some other issuer but in this case it’s your AWS service and your client, so you can trust you. If any third party wants to use it, you can send the certificate to them. We’ll come onto that later.</p>\n<p>The MSK cluster is going to use that certificate authority in two ways:</p>\n<ol>\n<li>It’s going to authenticate clients using it.</li>\n<li>It’s going to let clients authenticate it.</li>\n</ol>\n<p>(that’s why it’s <a href=\"https://www.cloudflare.com/en-gb/learning/access-management/what-is-mutual-tls/\">mutual transport layer security</a>, both sides have to authenticate that they know who they are)</p>\n<h3>Steps</h3>\n<p>To create a private CA, go to <a href=\"https://eu-west-2.console.aws.amazon.com/acm-pca/home?region=eu-west-2#/firstrunscreen\">AWS’s Private Certificate Authority</a> (beware the link is to eu west 2 region).</p>\n<p>Settings:</p>\n<ul>\n<li>Type: Root</li>\n<li>O,OU,C,CN, etc: set these sensibly for your company</li>\n<li>Key algorithm: RSA 2048 is fine at time of writing</li>\n<li>Certificate revocation options: none - they don’t work with Kafka. You use Kafka Access Control Lists (ACLs) to control revocation instead.</li>\n<li>CA permissions options: Check</li>\n<li>Pricing: ⚠ Check (it’s going to cost!)</li>\n<li>Click Create CA.</li>\n</ul>\n<p>That’s it. Click through to your certificate and make a note of the new private certificate authority Amazon Resource Name (ARN). Being the root of a certificate chain, the Certificate Authority has a special role but it’s just a certificate like any other. It will look something like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">-----BEGIN CERTIFICATE-----\r\nMIIEKjCCAxKgAwIBAgIQaEuWKnMW5/K/++B9NulGxTANBgkqhkiG9w0BAQsFADCB\r\nhTELMAkGA1UEBhMCR0IxHTAbBgNVBAoMFE15IENsaW5pY2FsIE91dGNvbWVzMRQw\r\nHQOr3V2CW1z6Idh6RS4=\r\n-----END CERTIFICATE-----</code></pre></div>\n<p>(Not a real certificate, just me banging the keyboard).</p>\n<h2>Export, convert the Private CA</h2>\n<p>The .NET client needs to make sure that the Kafka server it is talking to is the right one. If you’re using a Private CA then you will need to install it in the Windows Certificate store on every computer that needs a connection to Kafka (including giving it to 3rd parties if others are connecting to it).</p>\n<ul>\n<li>Log into the AWS Console.</li>\n<li>Find your Private CA, click Actions->Get CA Certificate</li>\n<li>Click “Export certificate body to a file”</li>\n<li>A file called <code class=\"language-text\">Certificate.pem</code> is downloaded.</li>\n<li>Rename the file <code class=\"language-text\">kafka_private_ca.pem</code></li>\n</ul>\n<p>The .NET client needs this certificate installed into the “Trusted Root Store” of the Certificate Manager. But <code class=\"language-text\">.pem</code> files are not supported, we need to convert it using <code class=\"language-text\">openssl</code>:</p>\n<ul>\n<li>Open Powershell to <code class=\"language-text\">kafka_private_ca.pem</code></li>\n<li>Use <code class=\"language-text\">openssl</code> to convert it to pkcs12 format:</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\">openssl pkcs12 <span class=\"token operator\">-</span>export <span class=\"token operator\">-</span>out kafka_private_ca<span class=\"token punctuation\">.</span>p12 <span class=\"token operator\">-in</span> kafka_private_ca<span class=\"token punctuation\">.</span>pem <span class=\"token operator\">-</span>nokeys</code></pre></div>\n<ul>\n<li>Add an export password and make a note of it, you will need it to install it</li>\n</ul>\n<p>NB: We need to use <code class=\"language-text\">-nokeys</code> because there are no private keys in the PEM file, openssl doesn’t know that unless we tell it.</p>\n<ul>\n<li>In windows explorer, double click the <code class=\"language-text\">kafka_private_ca.p12</code> and then go through the Certificate Import Wizard.</li>\n<li>Store Location: Local Machine</li>\n<li>File to Import: path should be to kafka_private_ca.p12</li>\n<li>Password: that you just set on <code class=\"language-text\">openssl pkcs12 export</code></li>\n<li>Automatically detect store</li>\n<li>Next and Finish.</li>\n</ul>\n<p>The AWS Private CA will now be installed on this computer. You will need to repeat the process for any computer you’re using it on. If a 3rd party wants to connect to your client, they will need this certificate too.</p>\n<h2>Create a Client Certificate</h2>\n<p>MSK needs to know that the client is authenticated to make calls. For that, the client needs it’s own certificate. Here are the steps:</p>\n<ul>\n<li>Create a new certificate called a client certificate with a signing request</li>\n<li>Use the signing request to ask the Private CA on AWS to sign the client certificate</li>\n<li>Get the newly signed client certificate from AWS</li>\n<li>Convert the newly signed client certificate into a format that the .NET Kafka client can use</li>\n</ul>\n<h3>Create a new client certificate and signing request</h3>\n<ul>\n<li>In PowerShell</li>\n<li>Create new certificate with signing request:</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\">openssl req <span class=\"token operator\">-</span>newkey rsa:2048 <span class=\"token operator\">-</span>nodes <span class=\"token operator\">-</span>keyout kafka_test_client<span class=\"token punctuation\">.</span>key <span class=\"token operator\">-</span>out kafka_test_client<span class=\"token punctuation\">.</span>csr</code></pre></div>\n<p>That will generate the key first:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Generating a RSA private key\r\n........................................................................................................................................................+++++\r\n.......................+++++\r\nwriting new private key to 'kafka_test_client.key'</code></pre></div>\n<p>Then ask you to fill in details for the certificate request:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">-----\r\nYou are about to be asked to enter information that will be incorporated\r\ninto your certificate request.\r\nWhat you are about to enter is what is called a Distinguished Name or a DN.\r\nThere are quite a few fields but you can leave some blank\r\nFor some fields there will be a default value,\r\nIf you enter '.', the field will be left blank.\r\n-----\r\nCountry Name (2 letter code) [AU]:UK\r\nState or Province Name (full name) [Some-State]:London\r\nLocality Name (eg, city) []:London\r\nOrganization Name (eg, company) [Internet Widgits Pty Ltd]:My Company\r\nOrganizational Unit Name (eg, section) []:Development\r\nCommon Name (e.g. server FQDN or YOUR name) []:mycompany.com\r\nEmail Address []:me@mycompany.com\r\n\r\nPlease enter the following 'extra' attributes\r\nto be sent with your certificate request\r\nA challenge password []: APassword\r\nAn optional company name []: My Company</code></pre></div>\n<ul>\n<li>Put in answers for country name (AU), Province, City, Organisation,</li>\n<li>FQDN is the Fully Qualified Domain name - you don’t need one of these but if you have a corporate web domain, use that: mycompany.com</li>\n<li>(Optional) It’s recommended that set a password. It can be blank if you are going to protect your certificate in some other way. If you use a password then make sure you store that in a secure place away from your certificates.</li>\n</ul>\n<p>At the end of that, two files are generated:</p>\n<ul>\n<li>The certificate signing request: <code class=\"language-text\">kafka_test_client.csr</code></li>\n<li>The certificate’s private key: <code class=\"language-text\">kafka_test_client.key</code></li>\n</ul>\n<blockquote>\n<p>Keep the .key file secret!</p>\n</blockquote>\n<h3>Sign the client certificate</h3>\n<p>We’re now going to take the certificate signing request and ask our AWS Private CA to sign it for us.</p>\n<ul>\n<li>From AWS, get the ARN of your Private CA certificate, e.g. <code class=\"language-text\">arn:aws:acm-pca:eu-west-2:123456789:certificate-authority/11111111-1111-1111-1111-111111111111</code></li>\n<li>Open PowerShell</li>\n<li>Sign the certificate:</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\">aws acm-pca issue-certificate <span class=\"token operator\">--</span>certificate-authority-arn <span class=\"token string\">\"arn:aws:acm-pca:eu-west-2:123456789:certificate-authority/11111111-1111-1111-1111-111111111111\"</span> <span class=\"token operator\">--</span>csr fileb:<span class=\"token operator\">/</span><span class=\"token operator\">/</span>kafka_test_client<span class=\"token punctuation\">.</span>csr <span class=\"token operator\">--</span>signing-algorithm <span class=\"token string\">\"SHA256WITHRSA\"</span> <span class=\"token operator\">--</span>validity Value=300<span class=\"token punctuation\">,</span><span class=\"token function\">Type</span>=<span class=\"token string\">\"DAYS\"</span></code></pre></div>\n<ul>\n<li>The result will be the ARN of the signed certificate in a JSON snippet:</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\r\n    <span class=\"token property\">\"CertificateArn\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"arn:aws:acm-pca:eu-west-2:123456789:certificate-authority/11111111-1111-1111-1111-111111111111/certificate/11111111111111111111111\"</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<blockquote>\n<p>Note: that’s just the id of the certificate, we haven’t downloaded it yet!</p>\n</blockquote>\n<ul>\n<li>Using the <code class=\"language-text\">CertificateArn</code> in the previous step, download the certificate:</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\">aws acm-pca <span class=\"token function\">get-certificate</span> <span class=\"token operator\">--</span>certificate-authority-arn <span class=\"token string\">\"arn:aws:acm-pca:eu-west-2:123456789:certificate-authority/11111111-1111-1111-1111-111111111111\"</span> <span class=\"token operator\">--</span>certificate-arn <span class=\"token string\">\"arn:aws:acm-pca:eu-west-2:123456789:certificate-authority/11111111-1111-1111-1111-111111111111/certificate/11111111111111111111111\"</span> <span class=\"token operator\">--</span>output text</code></pre></div>\n<ul>\n<li>The result looks like (not real certificates, real ones are longer):</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">-----BEGIN CERTIFICATE-----\r\nMIIEKjCCAxKgAwIBAgIQaEuWKnMW5/K/++B9NulGxTANBgkqhkiG9w0BAQsFADCB\r\nhTELMAkGA1UEBhMCR0IxHTAbBgNVBAoMFE15IENsaW5pY2FsIE91dGNvbWVzMRQw\r\nHQOr3V2CW1z6Idh6RS4=\r\n-----END CERTIFICATE-----       -----BEGIN CERTIFICATE-----\r\nMIID2DCCAsCgAwIBAgIQQJDUBmoYft8TvHvqvHN65DANBgkqhkiG9w0BAQsFADCB\r\nhTELMAkGA1UEBhMCR0IxHTAbBgNVBAoMFE15IENsaW5pY2FsIE91dGNvbWVzMRQw\r\nEgYDVQQLDAtEZXZlbG9wbWVudDEPMA0GA1UECAwGTG9uZG9uMR8wHQYDVQQDDBZt</code></pre></div>\n<ul>\n<li>Copy the whole result into a new file <code class=\"language-text\">kafka_test_client.cer</code>, this is the client certificate.</li>\n<li>Replace all the characters between <code class=\"language-text\">-----END CERTIFICATE-----</code> and <code class=\"language-text\">-----BEGIN CERTIFICATE-----</code> with a return carriage so that it looks like this:</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">-----BEGIN CERTIFICATE-----\r\nMIIEKjCCAxKgAwIBAgIQaEuWKnMW5/K/++B9NulGxTANBgkqhkiG9w0BAQsFADCB\r\nhTELMAkGA1UEBhMCR0IxHTAbBgNVBAoMFE15IENsaW5pY2FsIE91dGNvbWVzMRQw\r\nHQOr3V2CW1z6Idh6RS4=\r\n-----END CERTIFICATE-----\r\n-----BEGIN CERTIFICATE-----\r\nMIID2DCCAsCgAwIBAgIQQJDUBmoYft8TvHvqvHN65DANBgkqhkiG9w0BAQsFADCB\r\nhTELMAkGA1UEBhMCR0IxHTAbBgNVBAoMFE15IENsaW5pY2FsIE91dGNvbWVzMRQw\r\nEgYDVQQLDAtEZXZlbG9wbWVudDEPMA0GA1UECAwGTG9uZG9uMR8wHQYDVQQDDBZt</code></pre></div>\n<p>The <code class=\"language-text\">kafka_test_client.cer</code> and <code class=\"language-text\">kafka_test_client.key</code> files are used by the .NET client to authenticate. You don’t need the CSR again, if you’re going through a new signing, it’s best to start with a new key altogether.</p>\n<h2>Now Build Your MSK Cluster</h2>\n<p>Out of the scope of this blog, but once you have the Private CA, you can <a href=\"https://docs.aws.amazon.com/msk/latest/developerguide/msk-create-cluster.html\">create the MSK Cluster</a> using Mutual TLS. The client configuration will need the list of brokers, which is called the “bootstrap servers”.</p>\n<h2>.NET Client Config</h2>\n<p>Create a new .NET core command line application to test your code and install the Confluent.Kafka nuget package.</p>\n<p>We’re going to get a list of topics from the Kafka cluster.</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token comment\">// Get this from AWS MSK Console, select your cluster, click \"View Client Information\", public endpoint</span>\r\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> bootstrap <span class=\"token operator\">=</span> <span class=\"token string\">\"b-1-public.nameofcluster.xxxxx.c2.kafka.eu-west-2.amazonaws.com:9194,b-2-public.nameofcluster.xxxxx.c2.kafka.eu-west-2.amazonaws.com:9194\"</span><span class=\"token punctuation\">;</span>\r\n\r\n<span class=\"token comment\">// We're using Admin Client here but this will work for produce and consumer</span>\r\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> adminClientConfig <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">AdminClientConfig</span>\r\n<span class=\"token punctuation\">{</span>\r\n    BootstrapServers <span class=\"token operator\">=</span> bootstrap<span class=\"token punctuation\">,</span>\r\n    SecurityProtocol <span class=\"token operator\">=</span> SecurityProtocol<span class=\"token punctuation\">.</span>Ssl<span class=\"token punctuation\">,</span>\r\n    SslCertificateLocation <span class=\"token operator\">=</span> <span class=\"token string\">\"kafka_test_client.cer\"</span><span class=\"token punctuation\">,</span>\r\n    SslKeyLocation <span class=\"token operator\">=</span> <span class=\"token string\">\"kafka_test_client.key\"</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\r\n\r\n<span class=\"token keyword\">using</span> <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> adminClient <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">AdminClientBuilder</span><span class=\"token punctuation\">(</span>adminClientConfig<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n<span class=\"token comment\">// Get the cluster's metadata and print out the topics to the console.</span>\r\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> metadata <span class=\"token operator\">=</span> adminClient<span class=\"token punctuation\">.</span><span class=\"token function\">GetMetadata</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> topic <span class=\"token keyword\">in</span> metadata<span class=\"token punctuation\">.</span>Topics<span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">{</span>\r\n    Console<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"Topic - </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">topic<span class=\"token punctuation\">.</span>Topic</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>If you are struggling to get connected, add a <code class=\"language-text\">Debug</code>configuration item for more detail.</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> adminClientConfig <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">AdminClientConfig</span>\r\n<span class=\"token punctuation\">{</span>\r\n    Debug <span class=\"token operator\">=</span> <span class=\"token string\">\"broker,protocol,metadata,topic\"</span><span class=\"token punctuation\">,</span></code></pre></div>\n<h3>Note on CA Location</h3>\n<p>If you are running on Windows, you cannot use the client config <code class=\"language-text\">SslCaLocation</code> to reference a physical CA certificate. The .NET client only appears to obey the Windows Certificate Store. <a href=\"https://docs.confluent.io/platform/current/clients/confluent-kafka-dotnet/_site/api/Confluent.Kafka.ClientConfig.html#Confluent_Kafka_ClientConfig_SslCaLocation\">View the docs for more info</a>.</p>","frontmatter":{"title":"Connecting .NET to AWS Kafka (MSK)","date":"October 31, 2022","description":null}},"previous":{"fields":{"slug":"/2022-04-06-aws-mfa-on-powershell/"},"frontmatter":{"title":"Setting IAM Policy that forces MFA use on the command line"}},"next":null},"pageContext":{"id":"610e9902-24ec-5f65-9a84-6a269384c174","previousPostId":"21ce4606-5eea-5bb3-a059-06db19abfdca","nextPostId":null}},"staticQueryHashes":["2841359383","3257411868"]}