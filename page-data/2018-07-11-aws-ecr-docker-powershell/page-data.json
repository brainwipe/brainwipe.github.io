{"componentChunkName":"component---src-templates-blog-post-js","path":"/2018-07-11-aws-ecr-docker-powershell/","result":{"data":{"site":{"siteMetadata":{"title":"The Plastic Neuron"}},"markdownRemark":{"id":"86b76ebd-005e-5408-aa9e-727a1ab8f7c1","excerpt":"Amazon Web Services (AWS) Elastic Container Registry (ECR) is a store for your docker images. Once you create your images locally, you can push them up to the…","html":"<p>Amazon Web Services (AWS) <a href=\"https://aws.amazon.com/ecr/\">Elastic Container Registry</a> (ECR) is a store for your <a href=\"https://docs.docker.com/glossary/?term=image\">docker images</a>. Once you create your images locally, you can push them up to the ECR and in turn make them live. In this article, we’re going to use an AWS IAM account that has Multi Factor Authentication (MFA) switched on to push multiple containers to the registry using docker compose.</p>\n<h2>Revising Terminology</h2>\n<p>A docker <em>container</em> runs your live application. A docker <em>image</em> is the template that is used to create the container. It is a collection of files: executables, frameworks and static content. A docker <em>repository</em> is a set of docker images. You distinguish between different images in the repository using <em>tags</em>. A <em>registry</em> is a hosted service that holds repositories and their images. <a href=\"https://hub.docker.com/\">Docker Hub</a> is the default registry, we’re going to use the AWS <a href=\"https://aws.amazon.com/ecr/\">Elastic Container Registry</a>. <em>Docker compose</em> is a tool for dealing with multiple images at the same time.</p>\n<p>More detail in <a href=\"https://docs.docker.com/glossary/\">the offical Glossary</a>.</p>\n<h2>Pre-requisites</h2>\n<p>You will need the following:</p>\n<ul>\n<li>Up-to-date Powershell</li>\n<li><a href=\"https://docs.aws.amazon.com/powershell/latest/userguide/pstools-getting-set-up-windows.html\">AWS Tools for Powershell</a></li>\n<li>docker for Windows! Check out <a href=\"https://brainwipe.github.io/2017-10-30-oauth-on-docker-part1\">my guide</a> for doing that.</li>\n<li><a href=\"https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_mfa_enable.html\">MFA set up</a> on you IAM account and a device that can perform 2 factor authentication (I use my phone with <a href=\"https://support.google.com/accounts/answer/1066447?co=GENIE.Platform%3DAndroid&#x26;hl=en\">Google Authenticator</a>)</li>\n<li>The serial number of your MFA device. You can find it on the IAM user details and will look something like this: <code class=\"language-text\">arn:aws:iam::123123123123:mfa/Rob</code></li>\n</ul>\n<p>Ensure that you have created an AWS IAM user to communicate with AWS. Do not use your root user account. In the account detail for the IAM user, <a href=\"https://docs.aws.amazon.com/powershell/latest/userguide/pstools-appendix-sign-up.html\">create an access key and secret pair</a>. The secret will only be displayed once, so I’d copy it somewhere you know you can destroy it or leave the browser window open.</p>\n<p>You will then need to configure the AWS Powershell tools to use these credentials. Make sure that you’re using a profile that suits your machine, I used:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Set-AWSCredential -AccessKey THISISTHEACCESSKRY -SecretKey IMNOTPUTTINGTHESECRETONTHEINTERNET -StoreAs default</code></pre></div>\n<h2>My example App</h2>\n<p>For my example, I’m going to be using docker-compose that <a href=\"https://brainwipe.github.io/2017-10-30-oauth-on-docker-part1\">I introduced in my OAuth blog post</a>. The docker-compose file creates two images. It currently looks like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'3'</span>\r\n\r\n<span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\r\n<span class=\"token key atrule\">dockerdotnetoauth</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> dockerdotnetoauth\r\n    <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span>\r\n        <span class=\"token key atrule\">context</span><span class=\"token punctuation\">:</span> ./DockerDotNetOAuth\r\n        <span class=\"token key atrule\">dockerfile</span><span class=\"token punctuation\">:</span> Dockerfile\r\n\r\n<span class=\"token key atrule\">identityserver</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> identityserver\r\n    <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span>\r\n        <span class=\"token key atrule\">context</span><span class=\"token punctuation\">:</span> ./IdentityServer\r\n        <span class=\"token key atrule\">dockerfile</span><span class=\"token punctuation\">:</span> Dockerfile</code></pre></div>\n<h2>Create ECR Repositories</h2>\n<p>Log into AWS and go to Elastic Container Service (ECS), you’ll find ECR is listed at the end. Click <strong>Create Repository</strong> and give it the same name as your images (not required but saves a lot of confusion). For each image, you will get a Repository URI it will look something like:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">123123123123.dkr.ecr.eu-west-1.amazonaws.com/dockerdotnetoauth</code></pre></div>\n<p>The format is:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">&lt;your account number>.dkr.ecr.&lt;region>.amazonaws.com/&lt;name of image></code></pre></div>\n<p>These are empty repositories, they are just placeholders that you can put your images into.</p>\n<h2>Getting images into the repositories</h2>\n<p>There are two ways to do this: tag your image or update your docker compose. The <a href=\"https://docs.aws.amazon.com/AmazonECR/latest/userguide/docker-push-ecr-image.html\">official documentation</a> goes into great length about tagging and pushing an existing image. Instead, we’re going to update the docker compose file so that we can push more than one image at a time.</p>\n<p>Take the repository URI you got in the previous step and use it for the image name.</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'3'</span>\r\n\r\n<span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\r\n<span class=\"token key atrule\">dockerdotnetoauth</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> 123123123123.dkr.ecr.eu<span class=\"token punctuation\">-</span>west<span class=\"token punctuation\">-</span>1.amazonaws.com/dockerdotnetoauth\r\n    <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span>\r\n        <span class=\"token key atrule\">context</span><span class=\"token punctuation\">:</span> ./DockerDotNetOAuth\r\n        <span class=\"token key atrule\">dockerfile</span><span class=\"token punctuation\">:</span> Dockerfile\r\n\r\n<span class=\"token key atrule\">identityserver</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> 123123123123.dkr.ecr.eu<span class=\"token punctuation\">-</span>west<span class=\"token punctuation\">-</span>1.amazonaws.com/identityserver\r\n    <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span>\r\n        <span class=\"token key atrule\">context</span><span class=\"token punctuation\">:</span> ./IdentityServer\r\n        <span class=\"token key atrule\">dockerfile</span><span class=\"token punctuation\">:</span> Dockerfile</code></pre></div>\n<p>When you next build the docker compose (as with Visual Studio 2017) it will create the images with the full name. It is a big, ugly name but there’s currently no way to give it a domain CNAME. If you’re concerned that your AWS account number is going to be stored in source control, then I recommend not checking it in and having it part of your dev environment setup.</p>\n<h2>Log docker into AWS</h2>\n<p>To be able to push your images up to the registry, docker needs access to your AWS account. As we are using Multi Factor Authentication (MFA), you will need to have your device (phone) handy to get the MFA access code.</p>\n<p>The steps the script takes are:</p>\n<ul>\n<li>Open Powershell!</li>\n<li>Log into AWS Secure Token Server to get an access token.</li>\n<li>Get the docker login command from ECR</li>\n<li>Invoke the docker login command</li>\n</ul>\n<p>When requesting a token from AWS, you need to specify how long (in seconds) you want the token to last for. The maximum is 36 hours but it depends on your use case. If you are logging in purely to upload the latest image build then 300 seconds should be enough. If you are dev ops and uploading for a working day, then 28800 seconds (8 hours) is enough.</p>\n<p>To get the token and store it in a Powershell variable use:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$token = Get-STSSessionToken -DurationInSeconds &lt;how long in seconds> -SerialNumber &lt;mfa serial> -TokenCode &lt;code from the authenticator on your phone></code></pre></div>\n<p>For example:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$token = Get-STSSessionToken -DurationInSeconds 28800 -SerialNumber arn:aws:iam::123123123123:mfa/Rob -TokenCode 123123</code></pre></div>\n<p>We’re then going to get the docker login command from ECR and invoke it immediately:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"> Invoke-Expression –Command (Get-ECRLoginCommand -Credential $token).Command</code></pre></div>\n<p>Your local docker is now logged into ECR.</p>\n<h2>Push all your images via docker compose</h2>\n<p>The benefit of setting the image name in docker compose to the full ECR URI is that you can then push all of your built containers in one go. That’s useful if you’re using docker compose inside Visual Studio to build .NET Core Linux containers. Visual Studio doesn’t care what the image names are.</p>\n<p>To push all of your built images with the <code class=\"language-text\">:latest</code> tag up to ECR, use:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">docker-compose push</code></pre></div>\n<p>Your containers are now stored on ECR!</p>","frontmatter":{"title":"AWS Elastic Container Registry with docker compose on Powershell","date":"July 11, 2018","description":null}},"previous":{"fields":{"slug":"/2017-10-30-oauth-on-docker-part2/"},"frontmatter":{"title":"ASP.NET Core 2 API on Docker with OAuth (Part 2)"}},"next":{"fields":{"slug":"/2019-02-05-dotnetcore-linux-daemon/"},"frontmatter":{"title":".NET Core Linux Daemon"}}},"pageContext":{"id":"86b76ebd-005e-5408-aa9e-727a1ab8f7c1","previousPostId":"50ec8124-c2d7-55f7-ba6e-50b2a0577012","nextPostId":"808bd5f6-29a5-5fd4-a1db-ab2614f825d3"}},"staticQueryHashes":["2841359383","69202846"]}