{"componentChunkName":"component---src-templates-blog-post-js","path":"/2025-01-03-aws-codebuild-error-fixing/","result":{"data":{"site":{"siteMetadata":{"title":"The Plastic Neuron"}},"markdownRemark":{"id":"c396d352-319d-5ccc-9de9-a7d3b301d9f3","excerpt":"I was expecting this to be a longer post about the issues I had but I moved onto a new task halfway through. When I return to it, I’ll add more here…","html":"<p>I was expecting this to be a longer post about the issues I had but I moved onto a new task halfway through. When I return to it, I’ll add more here.</p>\n<h2>Authorisation failed for primary source</h2>\n<p>When building a contain in CodeBuild you receive an error:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">[Container] 2025/01/03 14:10:46.285161 Waiting for DOWNLOAD_SOURCE\r\nCLIENT_ERROR: authorization failed for primary source and source version d7e3388d....</code></pre></div>\n<p>This is telling you that code build does not have access to your code repository. If you’re using GitHub then that means the policy attached to the code build role needs to have access to the git code connector (called Codestar for legacy reasons).</p>\n<h3>How to fix</h3>\n<ul>\n<li>Copy the ARN of your source control connection <a href=\"https://eu-west-2.console.aws.amazon.com/codesuite/settings/connections?connections\">from here</a>\n<ul>\n<li>If that link doesn’t work, it’s in AWS Developer Tools -> Settings -> Connections</li>\n</ul>\n</li>\n<li>In CodeBuild, find your build project</li>\n<li>Go to Build Details tab</li>\n<li>Under Environment, click Service Role</li>\n<li>Edit the policy called CloudBuildeBasePolicy-name-of-project-awszone</li>\n<li>At the bottom add the following (replace URN of connection)</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\">    <span class=\"token punctuation\">{</span>\r\n        <span class=\"token property\">\"Effect\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Allow\"</span><span class=\"token punctuation\">,</span>\r\n        <span class=\"token property\">\"Action\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"codestar-connections:UseConnection\"</span><span class=\"token punctuation\">,</span>\r\n        <span class=\"token property\">\"Resource\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"[PUT ARN OF YOUR CODE CONNECTION HERE]\"</span>\r\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>Save policy</li>\n<li>Re-run the build pipeline</li>\n</ul>\n<h2>ECS Task - cannot pull container error</h2>\n<p>If you are deploying a task or service to ECS and you see this:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">CannotPullContainerError: pull image manifest has been retried 1 time(s): failed to resolve ref docker.io/mycontainer:latest: pull access denied, repository does not exist or may require authorization: server message: insufficient_scope: authorization failed</code></pre></div>\n<p>This means that ECS is trying to pull from Docker Hub (<code class=\"language-text\">docker.io</code>), whereas your container is probably in the Elastic Container registry. You need to put the full Elastic Container Registry (ECR) URI into the task definition or it will assume you’re pulling from <code class=\"language-text\">docker.io</code>.</p>\n<h3>How to fix</h3>\n<ul>\n<li>Open Elastic Container registry and find the container image you want to run a task for</li>\n<li>Copy the URI. It looks something like: <code class=\"language-text\">0123456789.dkr.ecr.eu-west-2.amazonaws.com/mycontainer</code></li>\n<li>Open the Task Definition for the ECS task that you’re running</li>\n<li>The top part of the file looks like:</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\r\n    <span class=\"token property\">\"family\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"mycontainer\"</span><span class=\"token punctuation\">,</span>\r\n    <span class=\"token property\">\"containerDefinitions\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\r\n        <span class=\"token punctuation\">{</span>\r\n            <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"cli\"</span><span class=\"token punctuation\">,</span>\r\n            <span class=\"token property\">\"image\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"mycontainer\"</span><span class=\"token punctuation\">,</span>\r\n            <span class=\"token property\">\"cpu\"</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\r\n            <span class=\"token property\">\"portMappings\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\r\n            <span class=\"token property\">\"essential\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\r\n            <span class=\"token property\">\"environment\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></code></pre></div>\n<ul>\n<li>Replace image with the ECR URI so it looks more like:</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\r\n    <span class=\"token property\">\"family\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"mycontainer\"</span><span class=\"token punctuation\">,</span>\r\n    <span class=\"token property\">\"containerDefinitions\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\r\n        <span class=\"token punctuation\">{</span>\r\n            <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"cli\"</span><span class=\"token punctuation\">,</span>\r\n            <span class=\"token property\">\"image\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"0123456789.dkr.ecr.eu-west-2.amazonaws.com/mycontainer\"</span><span class=\"token punctuation\">,</span>\r\n            <span class=\"token property\">\"cpu\"</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\r\n            <span class=\"token property\">\"portMappings\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\r\n            <span class=\"token property\">\"essential\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\r\n            <span class=\"token property\">\"environment\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></code></pre></div>\n<ul>\n<li>Save the task definition and create a new task.</li>\n</ul>","frontmatter":{"title":"AWS CodeBuild Error Fixing","date":"January 03, 2025","description":null}},"previous":{"fields":{"slug":"/2024-12-11-deploy-container-codedeploy/"},"frontmatter":{"title":"From GitHub to AWS ECS Serverless - Part 2 - Deploy"}},"next":{"fields":{"slug":"/2025-06-30-rds-postgresql-users/"},"frontmatter":{"title":"Changing user names in AWS RDS PostgreSQL"}}},"pageContext":{"id":"c396d352-319d-5ccc-9de9-a7d3b301d9f3","previousPostId":"0a3aa669-0d47-59a1-8c6d-c1f2f556746b","nextPostId":"c52883f7-ce43-5c06-a763-5e3687ed36ae"}},"staticQueryHashes":["2841359383","69202846"],"slicesMap":{}}