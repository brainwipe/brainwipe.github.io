{"componentChunkName":"component---src-templates-blog-post-js","path":"/2025-06-30-rds-postgresql-users/","result":{"data":{"site":{"siteMetadata":{"title":"The Plastic Neuron"}},"markdownRemark":{"id":"c52883f7-ce43-5c06-a763-5e3687ed36ae","excerpt":"If you want to replace users in AWS RDS Postgres, you need to use a particular process because AWS RDS does not give you access to the Postgress  role type, so…","html":"<p>If you want to replace users in AWS RDS Postgres, you need to use a particular process because AWS RDS does not give you access to the Postgress <code class=\"language-text\">SUPERUSER</code> role type, so you cannot use <code class=\"language-text\">REASSIGN OWNED</code> without following a grant process.</p>\n<p>The process has three users:</p>\n<ol>\n<li>A <code class=\"language-text\">super_user</code> that you will be logged in as to do the change</li>\n<li>A <code class=\"language-text\">from_user</code> is the current owner of the database</li>\n<li>A <code class=\"language-text\">to_user</code> is the next owner of the database</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">USER</span> to_user<span class=\"token punctuation\">;</span>\r\n\r\n<span class=\"token keyword\">GRANT</span> rdsadmin <span class=\"token keyword\">TO</span> super_user<span class=\"token punctuation\">;</span>\r\n<span class=\"token keyword\">GRANT</span> from_user <span class=\"token keyword\">TO</span> super_user<span class=\"token punctuation\">;</span>\r\n<span class=\"token keyword\">GRANT</span> to_user <span class=\"token keyword\">TO</span> super_user<span class=\"token punctuation\">;</span>\r\n\r\nREASSIGN OWNED <span class=\"token keyword\">BY</span> from_user <span class=\"token keyword\">TO</span> staging_teto_usernant_user<span class=\"token punctuation\">;</span>\r\n\r\n<span class=\"token keyword\">DROP</span> ROLE from_user<span class=\"token punctuation\">;</span></code></pre></div>\n<h2>Investigating users and ownerships</h2>\n<p>I found the following scripts helpful when working out what might have gone wrong.</p>\n<h3>List roles with memberships</h3>\n<p>Can be used against any database (including the <code class=\"language-text\">postgres</code> one).</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">WITH</span> roleagg <span class=\"token keyword\">AS</span> <span class=\"token punctuation\">(</span>\r\n    <span class=\"token keyword\">SELECT</span> \r\n        m<span class=\"token punctuation\">.</span>member<span class=\"token punctuation\">,</span> \r\n        ARRAY_AGG<span class=\"token punctuation\">(</span>mr<span class=\"token punctuation\">.</span>rolname<span class=\"token punctuation\">)</span> role_name\r\n    <span class=\"token keyword\">FROM</span> pg_catalog<span class=\"token punctuation\">.</span>pg_auth_members m\r\n    <span class=\"token keyword\">JOIN</span> pg_roles mr <span class=\"token keyword\">ON</span> <span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">.</span>roleid <span class=\"token operator\">=</span> mr<span class=\"token punctuation\">.</span>oid<span class=\"token punctuation\">)</span> \r\n    <span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> <span class=\"token number\">1</span>\r\n<span class=\"token punctuation\">)</span>\r\n\r\n<span class=\"token keyword\">SELECT</span> \r\n    r<span class=\"token punctuation\">.</span>rolname <span class=\"token keyword\">as</span> user_name<span class=\"token punctuation\">,</span> \r\n    roleagg<span class=\"token punctuation\">.</span>role_name\r\n<span class=\"token keyword\">FROM</span> pg_catalog<span class=\"token punctuation\">.</span>pg_roles r\r\n<span class=\"token keyword\">LEFT</span> <span class=\"token keyword\">JOIN</span> roleagg <span class=\"token keyword\">on</span> roleagg<span class=\"token punctuation\">.</span>member <span class=\"token operator\">=</span> r<span class=\"token punctuation\">.</span>oid\r\n<span class=\"token keyword\">WHERE</span> r<span class=\"token punctuation\">.</span>rolcanlogin\r\n<span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Example Output (given users from above)</p>\n<table>\n<thead>\n<tr>\n<th>user_name</th>\n<th>role_name</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>rdsadmin</td>\n<td>NULL</td>\n</tr>\n<tr>\n<td>rdstopmgr</td>\n<td>[“pg_monitor”]</td>\n</tr>\n<tr>\n<td>rdswriteforwarduser</td>\n<td>NULL</td>\n</tr>\n<tr>\n<td>super_user</td>\n<td>[“rdsadmin”, “from_user”, “to_user”]</td>\n</tr>\n<tr>\n<td>to_user</td>\n<td>NULL</td>\n</tr>\n</tbody>\n</table>\n<h3>List databases with owners</h3>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> \r\n    datname <span class=\"token keyword\">AS</span> db_name<span class=\"token punctuation\">,</span> \r\n    pg_catalog<span class=\"token punctuation\">.</span>pg_get_userbyid<span class=\"token punctuation\">(</span>datdba<span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> <span class=\"token string\">\"owner\"</span> \r\n<span class=\"token keyword\">FROM</span> pg_catalog<span class=\"token punctuation\">.</span>pg_database\r\n<span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Example Output (given users from above)</p>\n<table>\n<thead>\n<tr>\n<th>db_name</th>\n<th>owner</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>my_database</td>\n<td>to_user</td>\n</tr>\n<tr>\n<td>my_other_database</td>\n<td>to_user</td>\n</tr>\n</tbody>\n</table>\n<h3>List database tables (and other objects)</h3>\n<p>Use with a single database.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> \r\n    n<span class=\"token punctuation\">.</span>nspname <span class=\"token keyword\">AS</span> schema_name<span class=\"token punctuation\">,</span>\r\n    c<span class=\"token punctuation\">.</span>relname <span class=\"token keyword\">AS</span> rel_name<span class=\"token punctuation\">,</span>\r\n    pg_get_userbyid<span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">.</span>relowner<span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> owner_name\r\n  <span class=\"token keyword\">FROM</span> pg_class c\r\n  <span class=\"token keyword\">JOIN</span> pg_namespace n <span class=\"token keyword\">ON</span> n<span class=\"token punctuation\">.</span>oid <span class=\"token operator\">=</span> c<span class=\"token punctuation\">.</span>relnamespace\r\n<span class=\"token keyword\">WHERE</span> pg_get_userbyid<span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">.</span>relowner<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;></span> <span class=\"token string\">'rdsadmin'</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Example Output, rdsadmin schemas such as <code class=\"language-text\">pg_catalog</code> and <code class=\"language-text\">pg_toast</code> not included</p>\n<table>\n<thead>\n<tr>\n<th>schema_name</th>\n<th>rel_name</th>\n<th>owner_name</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>dbo</td>\n<td>my_dbo_table</td>\n<td>to_user</td>\n</tr>\n<tr>\n<td>public</td>\n<td>my_public_table</td>\n<td>to_user</td>\n</tr>\n</tbody>\n</table>","frontmatter":{"title":"Changing user names in AWS RDS PostgreSQL","date":"June 30, 2025","description":null}},"previous":{"fields":{"slug":"/2025-01-03-aws-codebuild-error-fixing/"},"frontmatter":{"title":"AWS CodeBuild Error Fixing"}},"next":null},"pageContext":{"id":"c52883f7-ce43-5c06-a763-5e3687ed36ae","previousPostId":"c396d352-319d-5ccc-9de9-a7d3b301d9f3","nextPostId":null}},"staticQueryHashes":["2841359383","69202846"],"slicesMap":{}}