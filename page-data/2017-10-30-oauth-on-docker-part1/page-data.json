{"componentChunkName":"component---src-templates-blog-post-js","path":"/2017-10-30-oauth-on-docker-part1/","result":{"data":{"site":{"siteMetadata":{"title":"The Plastic Neuron"}},"markdownRemark":{"id":"9295d434-7301-51ab-aeb2-5fba33edc128","excerpt":"I previously explained how to get a ASP.NET Core 1 site running on docker in this post we’re going to do a similar process but use .NET Core 2 an add OAuth…","html":"<p>I previously explained how to get a <a href=\"/2017-05-23-docker-linux-dotnet\">ASP.NET Core 1 site running on docker</a> in this post we’re going to do a similar process but use .NET Core 2 an add OAuth authentication. The first few steps are the same, it starts to change when we create our projects. <a href=\"https://oauth.net/\">OAuth</a> is a protocol for allow secure authorization. We will be using <a href=\"https://identityserver.io/\">Identity Server 4</a> running in its own container to provide us with a token when we give it a username and password.</p>\n<p>In this part we’ll set up the API and Identity Server. In <a href=\"/2017-10-30-oauth-on-docker-part2\">Part 2</a> we will add a client and authorization to this service.</p>\n<p>The finished code (for both parts) is on my <a href=\"https://github.com/brainwipe/DockerDotNetOAuth\">DockerDotNetOAuth</a> GitHub repository.</p>\n<h2>Why run a separate container for Identity Server?</h2>\n<p>You <em>can</em> run Identity Server in your <a href=\"https://identityserver4.readthedocs.io/en/release/quickstarts/0_overview.html\">existing ASP.NET Core MVC project</a>. However, containerisation gives us the ability to split up our application into separate micro services.</p>\n<p>The benefits of splitting out the Identity Server are:</p>\n<ul>\n<li>You can deploy authentication separately to your product domain and vice versa</li>\n<li>It’s easier to swap out your authentication framework if you start with it separated</li>\n<li>You can scale out your product domain without duplicating your authentication</li>\n</ul>\n<p>The drawback is that <strong>it’s more complicated</strong>! Hopefully, once you have it working then you can spend your time on building just your product domain.</p>\n<h2>Install Docker for Windows</h2>\n<p><a href=\"https://docs.docker.com/docker-for-windows/install/#download-docker-for-windows\">Download Docker for Windows</a>. I recommend the stable channel. I used the defaults for everything, I suggest you do too!</p>\n<p>Once docker for Windows is installed, find the docker whale icon in the status bar right click and choose <code class=\"language-text\">Settings...</code>. On the left of the settings window, choose <code class=\"language-text\">Shared Drives</code> and tick the box for <code class=\"language-text\">C:</code>. This will give the docker machine access to the files on the <code class=\"language-text\">C:</code> drive, which is doesn’t have by default.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0b2d1cc0bf13b1d7b892daaa9809fe6b/1e1c3/docker-settings-share-drive.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 65.18987341772153%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAB2HAAAdhwGP5fFlAAACUUlEQVR42p2T7WvTUBTGr4igH3SKf48wmIr/kJ/8IKLgfJ1TxKFDbQsKMnE61FYRZAMF54c5N1ZqaZc0L03SNG9Nmya5eTy5nW9DKnjhx7lJOM95zrk3rCW14Hct8OEAPOqLmKUxwFNBxhOKHDwZIiN+xCyJf2OIfIV6E6xab6AqaZBNB03dhukG8DwPkiRBURTIsgxd1/G3lWWZiJKs4NHiO4QdE6y0vIkHy1UUP9RR/CTjbdWAT4JyS4amqjAMA5ZliSK+78NxHARB8Ifg0xUVp+e34OkaWKPRxLemBKPThWF34fo9RFEkknOROI6pY44kSYhUxDRNhdhIMEPXG0D3MsQ2CaryNrWkIewFCHwPg34fMSWZ5GowiCiZ7wiNiOMEruNS0aHYDwmeJqMZmi2wtqbCtm3hyHVdhGEoHPRJOBcYN7vdz/1cUKVZ5W5yoXw2I0GOXTnj109BBay13RSnaZomDCIXTMhhLprS7ET8F9QJz1s28pZVBe22AU3TCJUEe+IQ/sfhIHeoKTLNzhPOfD8Ql/r9ag1nZ5/g4p0FXJl/gdnCa9wqlXGTELFYFu8u31ui70u4dHcRF+aeo/Z1Hczvduje+YQLu2OLStMzj8H2HcPeo6fAJo6DHSKOnPzFYWLiBNj+SbADk9hzcIr2Uyg/ewVmORacoCfunxuE4BnHx/Umzs29xPT9Cq4+rGCmWMG1QllwvVDZiWXcKL0RnL+9gDPUkXBY31iBWl2DuvUFZn0TrlxD1NExpEIR/eOpZwG98bRra5A2PsOrruI7bJ6oqrwckMQAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"The Docker Settings window showing the shared drive and the C drive ticked\"\n        title=\"\"\n        src=\"/static/0b2d1cc0bf13b1d7b892daaa9809fe6b/f058b/docker-settings-share-drive.png\"\n        srcset=\"/static/0b2d1cc0bf13b1d7b892daaa9809fe6b/c26ae/docker-settings-share-drive.png 158w,\n/static/0b2d1cc0bf13b1d7b892daaa9809fe6b/6bdcf/docker-settings-share-drive.png 315w,\n/static/0b2d1cc0bf13b1d7b892daaa9809fe6b/f058b/docker-settings-share-drive.png 630w,\n/static/0b2d1cc0bf13b1d7b892daaa9809fe6b/40601/docker-settings-share-drive.png 945w,\n/static/0b2d1cc0bf13b1d7b892daaa9809fe6b/78612/docker-settings-share-drive.png 1260w,\n/static/0b2d1cc0bf13b1d7b892daaa9809fe6b/1e1c3/docker-settings-share-drive.png 1670w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h2>Create the new Project</h2>\n<p>Click <code class=\"language-text\">File -> New Project</code> and under Visual C#/.NET Core choose a new ASP.NET Core Web Application. Give it a meaningful name (better than the one I came up with!) as below.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/7292204c37a291e03fb110bdf351c971/40601/aspnet-core2-create.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 69.62025316455697%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAB2HAAAdhwGP5fFlAAACSElEQVR42nWT627TQBCF8yLQxrG98SW7vt/WiZs0TQoplRBPh8QfhKANTVIKD3iYHdMg1PDj06y9e45ndsaDr58+4u7LZxy2d9jfG77R+h4/9zs87R7w+H2LX4f9cf3jYYunwwEHWj/S2rwz53ekfSQGeZLCFT5evT7H2blFcYhpt0CWVwgnCp4fQox9jGwXZ0MbQ8uG8CVr0qyCVCnth3AJRecHuqrQthcoigplWSMMFS6XS+R5gTiKGSEEHMeF6wpGSQVJ3GxusSHWqzdYXq3RlFWf4Wq1IcMaSiUIA4Wuu0CcJIiMYRzD83xY1gijkc1IKeH7AWkapGnBOknEKibDOIHWMxKnnF0QSLzdvCPTBWc+nc5R1y0ZZ0TOUesOSVKQ6YQSkL2OiGWEQU2lVlWLgDYnk4g3cy6/4azLQnPsDXuKvH82Z42GdQQbzrTm+vO8PB6wbQfDocVlPvNcrsGyLL7LZ7N/DRtN5V1SlvpoKIRHTRDHJhjM819cjMfeacOCmhIE/d0ZwzA0hmMW/Q9TgfnoSUPTFL4bakoSUWepU4Izcnrsl9hUtjGUMj6RYUpmFY1JPUfcrhBlNQ+t41KWJHJpqE9Ce9zlP9dkuhyZwa5S+lPoXkKZYnb9AbP1ezSzK9TtAmUzR1pMT6JUhizJ4HsB6R2uKhwLDDLK0CPnMX2tm6+Yop4hL0mYa0yi/AUhmSmaw+nFJRL6RVWcwqKKzAQMOumiCV3oiYlOT+CgDmyO5v0pWinQRR5WusTtcoHrtsJNW+A3XIPQC8Dax/kAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Creating a new ASP.NET Core 2 project\"\n        title=\"\"\n        src=\"/static/7292204c37a291e03fb110bdf351c971/f058b/aspnet-core2-create.png\"\n        srcset=\"/static/7292204c37a291e03fb110bdf351c971/c26ae/aspnet-core2-create.png 158w,\n/static/7292204c37a291e03fb110bdf351c971/6bdcf/aspnet-core2-create.png 315w,\n/static/7292204c37a291e03fb110bdf351c971/f058b/aspnet-core2-create.png 630w,\n/static/7292204c37a291e03fb110bdf351c971/40601/aspnet-core2-create.png 945w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>For the project settings, select Web API. If you want to make an MVC website rather than an API, then follow the tutorials on the <a href=\"http://docs.identityserver.io/en/release/quickstarts/0_overview.html\">Identity Server website</a>. At the top, select ASP.NET Core 2.0 in the framework drop down (it’s the default). Check the ‘Docker Support’ checkbox, select Linux as the OS, leave authentication unchecked (we’ll do that manually), click OK.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/01c608e8cc1aeef913c9b46886db7918/2e237/aspnet-core2-docker-linux.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 65.18987341772153%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAB2HAAAdhwGP5fFlAAACOklEQVR42m2SyW7bMBCG9Rx9qwJ9rQJFgd6K3nvtucfGzYIAaRtDtmztKyWKIiXZlmzHf4aSnTioB/g0I4D8h7MYmT1D4rvgSYg88pEFDrLQR+wsKfbQViW6RqGr5Ugj0Q+oY6ywqQX6zQrCeoARk1gQhnDTCn+WDFM7huO4SLMMKcsRsAo8F2hUDaUacF4iLzgKrikHzxhDIWsUjgmjZBm9yMbX2x4fvpj4dv8EZz7FpusxM02s+h7tg4m+KNE/7XF/d4ffkwlub25w9esKN9fXQzydW2DWPxi1KAH0+Hx9wLuPwKfJHq3IULcrhEGApmnQdRvsdjv0JL5wQ9heiCRJEMUR4ihGHMeQdL6wpzAaKaDtx/yA99/Jzw7Df7/dDQe14Mm6rgPj1AKhqHyFuq5HKFbtehRUokBcr/G03yHjivwe/9nhVVBJiaYeBaWsUFWEEK+Cq4pju92i67c0iJzi3ZnQ4Y3uhgT1AANqhe/7NCA+VCBJ9EVwrcTFy5dMv9B1Xdi2jcVyCctaICDhsuRQq6NgmSWQw0rU5HVfGsraHmneoMvUK3JCvzYkOC9Q1S3yxSOMLPTgeT5lXcL3PBR5DkE90eVUlXjt0xEteuKUSJ95KbnKU+pJiLnlwIkYln6KKEnHZS21iKQLZ9D/eYKRs6FIqj/JObwwgZ/kA0HCELMCIW/BZEs7uR4uXEJqmhXqfg/uWTD0RxYZVE69JAbPRioWocoiiPQyPIkwN+ewzBlmj39hTX7iGfIfzqeW9ouZAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Select Web API and check the Docker Tick box\"\n        title=\"\"\n        src=\"/static/01c608e8cc1aeef913c9b46886db7918/f058b/aspnet-core2-docker-linux.png\"\n        srcset=\"/static/01c608e8cc1aeef913c9b46886db7918/c26ae/aspnet-core2-docker-linux.png 158w,\n/static/01c608e8cc1aeef913c9b46886db7918/6bdcf/aspnet-core2-docker-linux.png 315w,\n/static/01c608e8cc1aeef913c9b46886db7918/f058b/aspnet-core2-docker-linux.png 630w,\n/static/01c608e8cc1aeef913c9b46886db7918/2e237/aspnet-core2-docker-linux.png 790w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Make sure you have Docker for Windows running and the docker-compose project is selected as the Start Up project and hit F5 to run the project. The Web API project comes with a default service endpoint that delivers a bit of JSON.</p>\n<h1>The Initial Docker Compose File</h1>\n<p>The docker-compose file is a <code class=\"language-text\">yml</code> file that describes what containers are going to be built and run when you press F5. So far we have a single container which will be called <code class=\"language-text\">dockerdotnetoauth</code>, and has a Docker File in the project directory. You’ll also notice that docker-compose has a child file <code class=\"language-text\">docker-compose.override.yml</code> that has bindings that visual studio needs.</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'3'</span>\r\n\r\n<span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\r\n<span class=\"token key atrule\">dockerdotnetoauth</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> dockerdotnetoauth\r\n    <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span>\r\n        <span class=\"token key atrule\">context</span><span class=\"token punctuation\">:</span> ./DockerDotNetOAuth\r\n        <span class=\"token key atrule\">dockerfile</span><span class=\"token punctuation\">:</span> Dockerfile</code></pre></div>\n<h2>Create Identity Server Project</h2>\n<p>A Secure Token Server (STS) uses the OAuth authentication mechanism. The STS gives a token to a client that the client passes to the API. The API then calls Identity Server to check that the token is valid.</p>\n<p>Identity Server is an STS implementation in .NET Core that plugs into the ASP.NET Core pipeline, so it needs a website to host it. We’re going to run that new website in a ASP.NET Core Linux docker container too.</p>\n<p>In the Solution Explorer, Right click the Solution, Add -> New Project. Create a new ASP.NET Core Web Application called IdentityServer. Create it as an Empty ASP.NET Core 2.0 project with Linux Docker support and no authentication.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/8072c9c04da81d8037364ecd124d2349/2e237/aspnet-core2-idsvr-create.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 65.18987341772153%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAB2HAAAdhwGP5fFlAAACNElEQVR42nWSu5LTMBSG/Ra8Fz2vwRPQ8gQ0VFvRUNDRMMMwNAt7y65zceKrbMm2JMtOYifZ/TlSkg0ZFo0/H8mS/6Nz8cTcRxGHqFiCnGwezt06CwOsGonBKPQO7RjaBkPXYNMZYj+3+8N6BTm9gjfyF/g5ihEVCkIIpBlDMJ+DFQVymuskgSk4TGPQEGVVg4sSORcoCC6s5eC1hgju4b37wvHmY4yL3z0W/jWG7Q6j0QjDMGDs+1gOPbqrewxljc3jDrc31/h1eYnpZAKf9seOBwRhDD69hff2s8Sr98DF9Q54XGHdb8DpRsvlEkkco21b9P0a2+3WOVlkJdJC0ncDYw40DcxqjTIYwfvwXeL1J+Bb+AQ7do9k6bECWZY5wePo+x5SKiilCeXQWkOTbbrVXtCoEpISagUCpsnu8M94OglagYZuZFF6L3wm2MoKKwpzGDYoS+GET0JPZ7pWkDGGPM+Rsxx1XbsIzgRta7z080vDCkZRhDAMES4WmM1mbl3XFZrlQbAuqDUOLaFtck1LXrsD7Rk2TE4tUlBLWWIqWkJtVVUllOkgpnfwioS8hRGCgLyR55L6SkpJhyrKj6ScqecCWI75s5U9OrJnnkNWIidPCcaTOeYpxyzKkVJ+7E3Kel9RV8kjf1X4hDwJaoqfiQphwhAx4YgZR8ZLJFUHrjsYOtz8B21plzDDDlU4gWdfuizQCMol4Szfo3gKVaSQ+ctULMX4YYzJgw//7gaTH1/xB3yy0JHYC/3dAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Create an empty ASP.NET Core 2 Web API project with Linux Docker support\"\n        title=\"\"\n        src=\"/static/8072c9c04da81d8037364ecd124d2349/f058b/aspnet-core2-idsvr-create.png\"\n        srcset=\"/static/8072c9c04da81d8037364ecd124d2349/c26ae/aspnet-core2-idsvr-create.png 158w,\n/static/8072c9c04da81d8037364ecd124d2349/6bdcf/aspnet-core2-idsvr-create.png 315w,\n/static/8072c9c04da81d8037364ecd124d2349/f058b/aspnet-core2-idsvr-create.png 630w,\n/static/8072c9c04da81d8037364ecd124d2349/2e237/aspnet-core2-idsvr-create.png 790w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Once the project has been built, you’ll notice that a new entry has been added to the docker-compose file, which now looks like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'3'</span>\r\n\r\n<span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\r\n<span class=\"token key atrule\">dockerdotnetoauth</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> dockerdotnetoauth\r\n    <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span>\r\n        <span class=\"token key atrule\">context</span><span class=\"token punctuation\">:</span> ./DockerDotNetOAuth\r\n        <span class=\"token key atrule\">dockerfile</span><span class=\"token punctuation\">:</span> Dockerfile\r\n\r\n<span class=\"token key atrule\">identityserver</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> identityserver\r\n    <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span>\r\n        <span class=\"token key atrule\">context</span><span class=\"token punctuation\">:</span> ./IdentityServer\r\n        <span class=\"token key atrule\">dockerfile</span><span class=\"token punctuation\">:</span> Dockerfile</code></pre></div>\n<p>This means that two separate containers will be built and run when you run the solution. If you press F5 right now then you’ll still see the original API service because that’s the default page. To see what’s running in docker open a PowerShell window and write <code class=\"language-text\">docker ps</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\">C:\\> docker <span class=\"token function\">ps</span>\r\nCONTAINER ID        IMAGE                   COMMAND               CREATED              STATUS              PORTS                   NAMES\r\n04e906a3617b        dockerdotnetoauth:dev   <span class=\"token string\">\"tail -f /dev/null\"</span>   About a minute ago   Up About a minute   0<span class=\"token punctuation\">.</span>0<span class=\"token punctuation\">.</span>0<span class=\"token punctuation\">.</span>0:32771->80/tcp   dockercompose3858451035021284432_dockerdotnetoauth_1\r\n639c48d06f11        identityserver:dev      <span class=\"token string\">\"tail -f /dev/null\"</span>   About a minute ago   Up About a minute   0<span class=\"token punctuation\">.</span>0<span class=\"token punctuation\">.</span>0<span class=\"token punctuation\">.</span>0:32772->80/tcp   dockercompose3858451035021284432_identityserver_1</code></pre></div>\n<p>Scroll to the right and you’ll see the Ports column that shows the mapping from localhost to the internal container port. You can see that the API container is on port <code class=\"language-text\">32771</code> and the empty identity server is on port <code class=\"language-text\">32772</code>. These ports might be different for you. To see the identity server, open a browser to <code class=\"language-text\">http://localhost:32772</code>. You’ll get a simple “Hello World!” for output.</p>\n<h2>Identity Server Install</h2>\n<p>We’re going to get Identity Server working first and then move onto authentication and authorization in <a href=\"/2017-10-30-oauth-on-docker-part2\">Part 2</a>.</p>\n<p>On your Identity Server project, install the <code class=\"language-text\">nuget</code> package <a href=\"https://www.nuget.org/packages/IdentityServer4/\">IdentityServer4.AspNetCore</a> by Brock Allen and Dominick Baier. Open the Identity Server <code class=\"language-text\">Startup.cs</code>. Remove the fluff (including Hello World) and add Identity Server to both the services and the application like so:</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Startup</span>\r\n<span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">ConfigureServices</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">IServiceCollection</span> services<span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">{</span>\r\n        services<span class=\"token punctuation\">.</span><span class=\"token function\">AddIdentityServer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n            <span class=\"token punctuation\">.</span><span class=\"token function\">AddDeveloperSigningCredential</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n\r\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">Configure</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">IApplicationBuilder</span> app<span class=\"token punctuation\">,</span> <span class=\"token class-name\">IHostingEnvironment</span> env<span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">{</span>\r\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>env<span class=\"token punctuation\">.</span><span class=\"token function\">IsDevelopment</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n        <span class=\"token punctuation\">{</span>\r\n            app<span class=\"token punctuation\">.</span><span class=\"token function\">UseDeveloperExceptionPage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token punctuation\">}</span>\r\n\r\n        app<span class=\"token punctuation\">.</span><span class=\"token function\">UseIdentityServer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Adding Identity Server Configuration</h2>\n<p>We need to tell Identity Server what API resources (called <strong>scopes</strong>)  we’re going to protect and who the <strong>clients</strong> are that are going to call them. For simplicity, we’re going to configure this in memory by hard coding a class called Configuration. In your Identity Server project, create a new class on the root called <code class=\"language-text\">Configuration.cs</code>. We’re going to follow the <a href=\"http://docs.identityserver.io/en/release/quickstarts/1_client_credentials.html\">Identity Server 4 guide</a> to create this class:</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Configuration</span>\r\n<span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token return-type class-name\">IEnumerable<span class=\"token punctuation\">&lt;</span>ApiResource<span class=\"token punctuation\">></span></span> <span class=\"token function\">GetApiResources</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">{</span>\r\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">List<span class=\"token punctuation\">&lt;</span>ApiResource<span class=\"token punctuation\">></span></span>\r\n        <span class=\"token punctuation\">{</span>\r\n            <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">ApiResource</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"api1\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"My API\"</span><span class=\"token punctuation\">)</span>\r\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n\r\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token return-type class-name\">IEnumerable<span class=\"token punctuation\">&lt;</span>Client<span class=\"token punctuation\">></span></span> <span class=\"token function\">GetClients</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">{</span>\r\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">List<span class=\"token punctuation\">&lt;</span>Client<span class=\"token punctuation\">></span></span>\r\n        <span class=\"token punctuation\">{</span>\r\n            <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Client</span>\r\n            <span class=\"token punctuation\">{</span>\r\n                ClientId <span class=\"token operator\">=</span> <span class=\"token string\">\"client\"</span><span class=\"token punctuation\">,</span>\r\n\r\n                <span class=\"token comment\">// no interactive user, use the clientid/secret for authentication</span>\r\n                AllowedGrantTypes <span class=\"token operator\">=</span> GrantTypes<span class=\"token punctuation\">.</span>ClientCredentials<span class=\"token punctuation\">,</span>\r\n\r\n                <span class=\"token comment\">// secret for authentication</span>\r\n                ClientSecrets <span class=\"token operator\">=</span>\r\n                <span class=\"token punctuation\">{</span>\r\n                    <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Secret</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"secret\"</span><span class=\"token punctuation\">.</span><span class=\"token function\">Sha256</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n                <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n\r\n                <span class=\"token comment\">// scopes that client has access to</span>\r\n                AllowedScopes <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> <span class=\"token string\">\"api1\"</span> <span class=\"token punctuation\">}</span>\r\n            <span class=\"token punctuation\">}</span>\r\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The configuration says that it will protect an API resource called “My API” with key <code class=\"language-text\">api1</code> and we have a single <code class=\"language-text\">Client</code> that is allowed to access the API if it has a secret, which is simply the hash of the string “secret”.</p>\n<p>Now return the <code class=\"language-text\">Startup.cs</code> file and add this configuration to Identity Server:</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Startup</span>\r\n<span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">ConfigureServices</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">IServiceCollection</span> services<span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">{</span>\r\n        services<span class=\"token punctuation\">.</span><span class=\"token function\">AddIdentityServer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n            <span class=\"token punctuation\">.</span><span class=\"token function\">AddDeveloperSigningCredential</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>    \r\n            <span class=\"token punctuation\">.</span><span class=\"token function\">AddInMemoryApiResources</span><span class=\"token punctuation\">(</span>Configuration<span class=\"token punctuation\">.</span><span class=\"token function\">GetApiResources</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n            <span class=\"token punctuation\">.</span><span class=\"token function\">AddInMemoryClients</span><span class=\"token punctuation\">(</span>Configuration<span class=\"token punctuation\">.</span><span class=\"token function\">GetClients</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n\r\n    <span class=\"token comment\">// snipped the rest for brevity</span></code></pre></div>\n<h2>Test Identity Server using its Discover Document</h2>\n<p>The <a href=\"https://tools.ietf.org/html/draft-ietf-oauth-discovery-06\">OAuth 2 specification</a> defines a discovery document, also known as the “well known” document which is a JSON file that explains how the secure token server can be used. When an API wants validate a token, it will look for the discovery document first.</p>\n<p>Now that you’ve specified scopes and clients, you can now see the well known on you docker container Identity Server: <code class=\"language-text\">http://localhost:32772/.well-known/openid-configuration</code>. Here’s what it looks like in a browser:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e00d104a52bd5136609306cdefcd5fc3/c3fd4/aspnet-core2-wellknown.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 83.54430379746836%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAB2HAAAdhwGP5fFlAAACIUlEQVR42p2T63KbMBCF/f5P0x9p+xqd6SVJ3RlzByEhEAIkAfbpwY7bTtM0l/XsAGb5dLR7tNNFjCqNkccHZEkKUZZQUmKwFiNzeMh5tFim37m6Ab7vYLXEymc/sK6MsJOiQqMU7lONd58n3Hx1uPni8OF2xvtvHjfMj3cBwgQsywwXZvgQ4PyWHmFeICmgblq0VY5dmAbYTcUwwHAlbTsoq9HYFtP24bxBAj8MBHn42Z/vT6cTpmmEohhBUVGcQKYH7I4skKpBURQQskKlSsiuRtnx/pptidpILtKgHTsEKr3GBt5yi05kF6DWGnmeo8gL6I7q+oYgcYaWhAkjIAnsncXxeMTfcQUakV8VSqRZhizNqLQkUBFUINM50iZBqjg0XSCSESTf/Rd4WthwNnX/fY/D4YCYvSiqDDn7kokarTXoJwNLdb3r2dfpeYU1gSktE8cR4iR52H7NVli48YiH+ifjEdDSQ0VdQrcNJjed+7SuC68rr2z6H79ngat3tEKAGQ0GP5wt8dp4pFDpBnHG7eYRcprTcZG3ALtqsw3NOnN7acNBcKrSKqz/sMZLgEMjsFv8dD5KZjDn/i08Suu6/ip6DTCY5qJwJEjoGs55HqcJIYQ3AX2nNqBDWAMSmrcdGizc/qXq+OI80Q0XoLwMZeGfOY9X0pWwfD69ccreaOzG9B4m3aNL7tDGd9DRLfpsDy+iF6erDggqRf/jE34CzuEivHNjMTUAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"The Identity Server Discovery Document\"\n        title=\"\"\n        src=\"/static/e00d104a52bd5136609306cdefcd5fc3/f058b/aspnet-core2-wellknown.png\"\n        srcset=\"/static/e00d104a52bd5136609306cdefcd5fc3/c26ae/aspnet-core2-wellknown.png 158w,\n/static/e00d104a52bd5136609306cdefcd5fc3/6bdcf/aspnet-core2-wellknown.png 315w,\n/static/e00d104a52bd5136609306cdefcd5fc3/f058b/aspnet-core2-wellknown.png 630w,\n/static/e00d104a52bd5136609306cdefcd5fc3/c3fd4/aspnet-core2-wellknown.png 854w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h2>End of Part 1</h2>\n<p>We have created an ASP.NET Core 2 Web API running in a Linux docker container, then added Identity Server into its own container and configured it. In <a href=\"/2017-10-30-oauth-on-docker-part2\">Part 2</a> we will create a client container and apply authorization to the Web API so that you’ll need the secret to access it.</p>","frontmatter":{"title":"ASP.NET Core 2 API on Docker with OAuth (Part 1)","date":"October 30, 2017","description":null}},"previous":{"fields":{"slug":"/2017-10-10-di-on-dotnet-core-cli/"},"frontmatter":{"title":"Using Dependency Injection on the .NET Core Command Line"}},"next":{"fields":{"slug":"/2017-10-30-oauth-on-docker-part2/"},"frontmatter":{"title":"ASP.NET Core 2 API on Docker with OAuth (Part 2)"}}},"pageContext":{"id":"9295d434-7301-51ab-aeb2-5fba33edc128","previousPostId":"58b0a936-65a0-5331-9760-588840c5bfdb","nextPostId":"1ec0fa69-bd1f-56b5-83f6-2fc85621fe7a"}},"staticQueryHashes":["2841359383","69202846"],"slicesMap":{}}