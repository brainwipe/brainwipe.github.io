{"componentChunkName":"component---src-templates-blog-post-js","path":"/2022-11-23-postgresql-turn-on-stats/","result":{"data":{"site":{"siteMetadata":{"title":"The Plastic Neuron"}},"markdownRemark":{"id":"ffc29e67-62e0-5377-9501-dd3469ec10d5","excerpt":"Your cloud provider is showing you that some of your PostgreSQL queries are slow. Your cloud provider is showing you SQL, and you might have set  to something…","html":"<p>Your cloud provider is showing you that some of your PostgreSQL queries are slow. Your cloud provider is showing you SQL, and you might have set <a href=\"https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_PerfInsights.UsingDashboard.SQLTextSize.html\"><code class=\"language-text\">track_activity_query_size</code></a> to something larger than 4096 bytes, so you can see your larger SQL statements.</p>\n<p>Now you want to reproduce locally but where can you get those statistics from?</p>\n<p>The process is much the same for Windows and other OSes but I’ll be doing it on Windows.</p>\n<h2>Switch on <code class=\"language-text\">pg_stat_statements</code></h2>\n<ul>\n<li>Find Postgres configuration file</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\">psql <span class=\"token operator\">-</span>U postgres <span class=\"token operator\">-</span>c <span class=\"token string\">'SHOW config_file'</span>\r\n<span class=\"token comment\"># C:\\Program Files\\PostgreSQL\\13\\data\\postgresql.conf # For Postgres 13 on Windows 10</span></code></pre></div>\n<ul>\n<li>Open the Postgres configuration file.</li>\n<li>Find <code class=\"language-text\">shared_preload_libraries</code>, it’s probably commented out</li>\n<li>Uncomment the line and change to:</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"inf\"><pre class=\"language-inf\"><code class=\"language-inf\">shared_preload_libraries = &#39;pg_stat_statements&#39;\t# (change requires restart)</code></pre></div>\n<h2>Restart PostgreSQL</h2>\n<p>For the extension to be available, you need to restart the Postgres server. Use the data directory of your Postgres installation. For Postgres 13 on Windows 10:</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\">pg_ctl <span class=\"token operator\">-</span>D <span class=\"token string\">\"C:\\Program Files\\PostgreSQL\\13\\data\"</span> restart</code></pre></div>\n<p>Restarting your computer will also work. You also have these commands for manual stop/start:</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\">pg_ctl <span class=\"token operator\">-</span>D <span class=\"token string\">\"C:\\Program Files\\PostgreSQL\\13\\data\"</span> stop\r\npg_ctl <span class=\"token operator\">-</span>D <span class=\"token string\">\"C:\\Program Files\\PostgreSQL\\13\\data\"</span> <span class=\"token function\">start</span></code></pre></div>\n<h2>Create extension in database</h2>\n<p>Open your favourite editor (I use <a href=\"https://www.jetbrains.com/datagrip/\">DataGrip by Jetbrains</a>), select your database and run the following query to switch on the stats creation:</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> EXTENSION pg_stat_statements<span class=\"token punctuation\">;</span></code></pre></div>\n<h2>Get basic statistics</h2>\n<p>From this point on, Postgres will start logging statistics on queries. To get at those queries, use:</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> pg_stat_statements</code></pre></div>\n<p>You can now google for uses of <code class=\"language-text\">pg_stat_statements</code> to drill down for your specific needs.</p>\n<h2>Troubleshooting</h2>\n<p>If you see the error:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">database> CREATE EXTENSION pg_stat_statements\r\n[2022-11-23 11:21:01] completed in 78 ms\r\ndatabase.public> select * from pg_stat_statements\r\n[2022-11-23 11:21:43] [55000] ERROR: pg_stat_statements must be loaded via shared_preload_libraries</code></pre></div>\n<p>Then it means you need to switch on <code class=\"language-text\">pg_stat_statements</code>, see above.</p>","frontmatter":{"title":"Find out what SQL queries are slow on PostgreSQL locally","date":"November 23, 2022","description":null}},"previous":{"fields":{"slug":"/2022-11-02-troubleshoot-aws-msk-dotnet/"},"frontmatter":{"title":"Troubleshooting Connecting .NET to MSK"}},"next":{"fields":{"slug":"/2022-11-24-build-aspnet-codebuild/"},"frontmatter":{"title":"From GitHub to AWS ECS Serverless - Part 1 - Build"}}},"pageContext":{"id":"ffc29e67-62e0-5377-9501-dd3469ec10d5","previousPostId":"37f59afc-cecb-57d8-b8f5-fabb74a50a10","nextPostId":"f41941c8-326a-5030-87b6-a177bbb40e4e"}},"staticQueryHashes":["2841359383","69202846"],"slicesMap":{}}